@using NurseCourse.Models
@{
    Layout = "~/Views/Shared/_Layout.cshtml"; // Utiliza este layout si tienes uno, o define null para no usar ningún layout
}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Home</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <style>
        body {
            background-color: #F5F5F5;
            background-size: cover;
            background-blend-mode: darken;
        }
        .animation:hover {
          transform: translateY(-3px);
          border-bottom: 3px solid ;
          background-color: #dbdbdb;
          transition: transform 0.2s;
    using Microsoft.EntityFrameworkCore.Metadata.Internal;
        }
        .titlenurse {
            background-color: #D9D9D9;
            display: flex;
            padding: 10px;
            padding-left: 15px;
            width: 100%;
            flex-direction: row;
            align-items: center;
        }
        form {
            background-color: #F5F5F5;
            padding: 20px;
            width: 500px;
        }
        .imgsection {
            display: flex;
            justify-content: flex-end;
            margin-left: auto; 
        }
        .subtitle {
            margin: 1%;
            padding: 1%;
            background-color: black;
            color: white;
            width: 400px;
            align-items: center;
            justify-items: center;
        }
        .container {
            flex-direction: column;
            display: flex;
        }
        .horizontal{
            margin: 1%;
            display: flex;
            flex-direction: row;
        }
        h5{
            margin: 1%;
        }
    </style>
</head>
<body>
<div class="titlenurse">
    <h1 class="">Detalle del curso</h1>
    <div class="imgsection"><img src="https://cdn.icon-icons.com/icons2/3005/PNG/512/modules_apps_icon_188198.png" alt="Curso" style="width: 100px; height: 100px;"></div>
    
</div>
<div class="horizontal">
    @if(@ViewData["Link1"] == null || @ViewData["Link2"] == null){
        <p>No hay links</p>
    }else{
        <div class="subtitle">Diagnostico: @ViewData["Link1"]</div>
        <div class="subtitle">Examen final: @ViewData["Link2"]</div>
    }
</div>
<h5>Tabla de estudiantes</h5>
<table class="table">
    <thead>
        <tr>
            <th>Nombre</th>
            <th>Email</th>
            <th>Nota actual</th>
            <th>Actualizar nota</th>
        </tr>
    </thead>
    <tbody>
    @if(Model.Item2 == null)
    {
        <tr>
            <td colspan="4">No hay usuarios registrados</td>
        </tr>
    }else{
        @foreach (var modulo in Model.Item2)
        {
            var idnew = (int)(@ViewData["id"] ?? 0);
            var idUser = @modulo.usuarioId;

            <tr class="animation">
                <td>@modulo.nombre</td>
                <td>@modulo.correoElectronico</td>                
                <td>
                    @if(modulo.nombre != null){
                        var aux = 0; 
                        var IdScore = 0; 
                        @foreach (var notas in modulo.notasExamenes){
                        var id = (int)(@ViewData["id"] ?? 0);                                              
                        @if(@notas.examenId == id){
                            IdScore = (int)(@notas.calificacion);                                                       
                        }                       
                     }
                     @IdScore
                    }
                     
                     
                </td>
                <td>
                    <div class="mb-3">
                        <input type="number" class="form-control" id="Diagnostico" name="Diagnostico" required>
                    </div>
                </td>
                <td><button type="button" class="btn btn-primary" onclick="actualizarNotas(@idnew, @idUser)">Actualizar</button></td>
            </tr>
        }
    }
    
    </tbody>
</table>
<h5>Tabla de modulos</h5>
<table class="table">
    <thead>
        <tr>
            <th>Nombre</th>
            <th>Descripción</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
    @if(Model.Item1 == null)
    {
        <tr>
            <td colspan="4">No hay cursos registrados</td>
        </tr>
    }else{
        @foreach (var modulo in Model.Item1)
        {
            <tr class="animation">
                <td>@modulo.nombre</td>
                <td>@modulo.descripcion</td>
            </tr>
        }
    }
    
    </tbody>
</table>
    <script>
        var valor = sessionStorage.getItem('UserRole');
        console.log("UserRole:"+valor);
        if(valor == 1){
            console.log("eres user, fuera de aqui");
            window.location.href = "http://localhost:5053/Student/Index";
        }
        function submitCurso() {
            var curso = {
                Descripcion: document.getElementById('Diagnostico').value
            };

            fetch('http://localhost:5053/api/Cursos', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(curso)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Success:', data);
                submitExamenFinal(data.cursoId);
                submitDiagnostico(data.cursoId);
                alert('curso registrado con éxito!');
            })
            .catch((error) => {
                console.error('Error:', error);
                alert('Error al registrar el curso');
            });
        }
        function submitExamenFinal(id) {
            var examenfinal = {
                Titulo: "Examen Final",
                CursoId: id,
                LinkExame: document.getElementById('Final').value
            };

            fetch('http://localhost:5053/api/Examenes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(examenfinal)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Success:', data);
                alert('examenfinal registrado con éxito!');
            })
            .catch((error) => {
                console.error('Error:', error);
                alert('Error al registrar el examenfinal');
            });
        }
        function submitDiagnostico(id) {
            var examendiagno = {
                Titulo: "Diagnostico",
                CursoId: id,
                LinkExame: document.getElementById('Diagnostico').value
            };

            fetch('http://localhost:5053/api/Examenes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(examendiagno)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Success:', data);
                alert('examendiagno registrado con éxito!');
            })
            .catch((error) => {
                console.error('Error:', error);
                alert('Error al registrar el examendiagno');
            });
        }
            function actualizarNotas(holax, iduser) {
                
                console.log(iduser+"hola:"+holax);
                 // Crear objeto de solicitud
                var xhr = new XMLHttpRequest();

                // Configurar la solicitud
                xhr.open("POST", "http://localhost:5053/api/NotaExamenes", true);
                xhr.setRequestHeader("Content-Type", "application/json");

                // Definir el cuerpo de la solicitud
                var body = JSON.stringify({
                    "UsuarioId": iduser,
                    "ExamenId": holax,
                    "Calificacion": document.getElementById('Diagnostico').value
                });

                // Manejar la respuesta de la solicitud
                xhr.onload = function () {
                    if (xhr.status === 200) {
                    console.log("Notas actualizadas exitosamente.");
                    window.location.href ="http://localhost:5053/Nurse/DetallesCurso/"+holax
                    } else {
                    console.error("Error al actualizar las notas. Código de estado: " + xhr.status);
                    window.location.href = "http://localhost:5053/Nurse/DetallesCurso/"+holax
                    }
                };

                // Enviar la solicitud
                xhr.send(body);
            }
    </script>
</body>
</html>